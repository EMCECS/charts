apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Values.application.testAppName }}
  labels:
    release: {{ .Release.Name }}
spec:
  template:
    spec:
      serviceAccountName: {{ .Values.application.testAppName }} 
{{- if .Values.global.registrySecret }}
      imagePullSecrets:
        - name: {{ .Values.global.registrySecret }}
{{- end }}
      restartPolicy: Never
      containers:
      - name: {{ .Values.application.testAppName }} 
{{- if .Values.image.tag }}
        image: {{ .Values.global.registry }}/{{ .Values.image.repository }}:{{ .Values.image.tag }}
{{- else }}
        image: {{ .Values.global.registry }}/{{ .Values.image.repository }}:{{ .Values.tag }}
{{- end }}
{{- if .Values.image.pullPolicy }}
        imagePullPolicy: {{ .Values.image.pullPolicy }}
{{- else }}
        imagePullPolicy: {{ .Values.pullPolicy }}
{{- end }}
        command: DKS-testapp 
        #command: ["/bin/sh"]
        #args: ["-c", "while true; do echo hello; sleep 10;done"]
        env:
        - name: TEST_APP_NAME
          value: {{ .Values.application.testAppName }}
        - name: SRS_GATEWAY_NAME
          value: {{ .Values.srsGateway.name }}
        - name: SRSGATEWAY_NAMESPACE
          value: {{ .Values.srsGateway.namespace }}
        - name: REGISTRY_SECRET
          value: {{ .Values.global.registrySecret }}
        envFrom:
        - configMapRef:
            name: {{ .Values.application.testAppName }}
  backoffLimit: 4
