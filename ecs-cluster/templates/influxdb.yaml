---
{{ if .Values.features.enableAdvancedStatistics }}
apiVersion: influxdata.com/v1alpha1
kind: Influxdb
metadata:
  name: {{ .Release.Name }}-influxdb
  labels:
    app.kubernetes.io/name: {{ .Release.Name }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    app.kubernetes.io/version: {{ .Chart.AppVersion }}
    app.kubernetes.io/part-of: {{ .Release.Name }}
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
    operator: objectscale-operator
    product: objectscale
    release: {{ .Release.Name }}
  namespace: {{ .Release.Namespace }}

spec:
{{- if .Values.started }}
  size: 1
{{- else }}
  size: 0
{{- end }}
  baseImage: {{ .Values.global.registry }}/{{ .Values.influxdb.image.repository }}:{{ default .Values.tag .Values.influxdb.image.tag }}
  imagePullPolicy: {{ default .Values.pullPolicy .Values.influxdb.image.pullPolicy }}
  pod:
    env:
      - name: FLEX
        value: true
    resources:
      limits:
        cpu: 800m
        memory: 2Gi
      requests:
        cpu: 100m
        memory: 500Mi
    persistentVolumeClaim:
      metadata:
        name: {{ .Release.Name }}-influxdb-data-pvc
      labels:
        app: {{ .Release.Name }}-influxdb
        release: {{ .Release.Name }}
      spec:
        accessModes: [ "ReadWriteOnce" ]
        storageClassName: {{ default .Values.storageClassName  .Values.influxdb.persistence.storageClassName }}
        resources:
          requests:
            storage: {{ .Values.influxdb.persistence.size }}
    volumes:
      - name: config
        configMap:
          name: influxdb-config
{{ end }}
