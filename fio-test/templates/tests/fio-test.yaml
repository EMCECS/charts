apiVersion: v1
kind: Pod
metadata:
  name: {{ .Release.Name }}
  labels:
    release: {{ .Release.Name }}
  namespace: {{ .Release.Namespace}}
  annotations:
    "helm.sh/hook": test-success
spec:
    containers:
      - name: {{ .Release.Name }}
        image: {{ .Values.global.registry }}/{{ .Values.image.repository}}:{{ .Values.image.tag }}
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        volumeMounts:
          - name: {{ .Release.Name }}-test-volume
            mountPath: /data
          - name: {{ .Release.Name }}-config-volume
            mountPath: /etc/config
        command: ["/bin/sh", "-c"]
        args: ["rm -r /data/*;
              /usr/local/bin/fio /etc/config/default-config.fio
              --output-format=json
              --output=/data/fio.out;
              cat /data/fio.out"]
    volumes:
      - name: {{ .Release.Name }}-test-volume
        persistentVolumeClaim:
          claimName: {{ .Release.Name }}-test-volume
      - name: {{ .Release.Name }}-config-volume
        configMap:
          name: {{ .Release.Name }}-config
    restartPolicy: Never