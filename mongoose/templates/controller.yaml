{{- define "mdrivers" -}}
{{- $dr := dict "drivers" (list) -}}
{{- $name := .Release.Name -}}
{{- range int .Values.replicas | until -}}
{{- $noop := printf "%s-driver-%d.%s-driver" $name . $name | append $dr.drivers | set $dr "drivers" -}}
{{- end -}}
{{- join "," $dr.drivers -}}
{{- end -}}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-controller
  namespace: {{ .Release.Namespace }}
spec:
  selector:
    matchLabels:
      name: {{ .Release.Name }}-controller
  template:
    metadata:
      labels:
        name: {{ .Release.Name }}-controller
        release: {{ .Release.Name }}
    spec:
      containers:
      - name: controller
        image: {{ .Values.controller.image.name }}:{{ .Values.controller.image.tag }}
        imagePullPolicy: {{ .Values.controller.image.pullPolicy }}
        command:
        - "/bin/sh"
        - "-c"
        args:
        - >
          mkdir -p /conf
          && echo 'var createConfig = {}; var readConfig = {"load" : {"type" : "read"} }; ChainLoad.config(createConfig).config(readConfig).run();' > /conf/mongoose-chain.js
          && /usr/bin/mongoose -jar /opt/mongoose/mongoose.jar
          --test-scenario-file=/conf/mongoose-chain.js
          --test-step-limit-fail-count={{ .Values.stepLimitFailCount }}
          --load-limit-concurrency={{ .Values.load.concurrencyLimit }}
          --item-data-size={{ .Values.load.itemDataSize }}
          --storage-driver-remote
          --storage-auth-uid={{ required "target.accessKey is required" .Values.target.accessKey }}
          --storage-auth-secret={{ required ".target.secretKey is required" .Values.target.secretKey }}
          --storage-net-node-port={{ required "target.port is required" .Values.target.port }}
          --storage-net-node-addrs={{ required "target.addresses is required" .Values.target.addresses }}
          --storage-driver-addrs="{{ template "mdrivers" . }}"
