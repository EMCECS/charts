#
# Copyright Â© [2020] Dell Inc. or its subsidiaries.
# All Rights Reserved.
#
# This software contains the intellectual property of Dell Inc.
# or is licensed to Dell Inc. from third parties. Use of this
# software and the intellectual property contained therein is expressly
# limited to the terms and conditions of the License Agreement under which
# it is provided by or on behalf of Dell Inc. or its subsidiaries.
#
#

#
# Influxdb replicas
#
{{- define "common-lib.influxdb_replicas" -}}
{{- if not .Values.global.started -}}
0
{{- else if .Values.global.influxdb_replicas -}}
{{- .Values.global.influxdb_replicas -}}
{{- else if eq (".Values.global.performanceProfile" | upper) "MICRO" -}}
1
{{- else -}}
3
{{- end -}}
{{- end -}}

#
# Influxdb hosts list
#
{{- define "common-lib.influxdb_hosts" -}}
{{- $top := . -}}
{{- $replicas := include "common-lib.influxdb_replicas" . -}}
{{- range $i, $e := until (int $replicas) -}}
{{- if $i}},{{end -}}
{{- if $top.Values.global.tls_enabled -}}
127.0.0.1{{$i}}:8{{$i}}86
{{- else -}}
{{- $top.Release.Name }}-influxdb-{{$i}}.{{ $top.Release.Name }}-influxdb.{{ $top.Release.Namespace }}.svc.cluster.local:8086
{{- end -}}
{{- end -}}
{{- end -}}

#
# Memory limit
#
{{- define "common-lib.memory" -}}
{{- if .top.Values.resources.requests.memory -}}
{{- .top.Values.resources.requests.memory -}}
{{- else -}}
{{- if eq (.top.Values.global.performanceProfile | upper) "MICRO" -}}
{{- .micro -}}
{{- else if eq (.top.Values.global.performanceProfile | upper) "SMALL" -}}
{{- .small -}}
{{- else if eq (.top.Values.global.performanceProfile | upper) "MEDIUM" -}}
{{- .medium -}}
{{- else -}}
{{- .large -}}
{{- end -}}
{{- end -}}
{{- end -}}

#
# Resources section
#
{{- define "common-lib.resources" -}}
requests:
  memory: {{ template "common-lib.memory" (dict "top" .top "micro" .micro "small" .small "medium" .medium "large" .large) }}
limits:
  memory: {{ template "common-lib.memory" . }}
{{- end }}

#
# Application replica count
#
{{- define "common-lib.replicaCount" -}}
{{- if not .top.Values.global.started -}}
0
{{- else if .top.Values.replicaCount -}}
{{- .top.Values.replicaCount -}}
{{- else if eq (.top.Values.global.performanceProfile | upper) "MICRO" -}}
{{- .micro -}}
{{- else if eq (.top.Values.global.performanceProfile | upper) "SMALL" -}}
{{- .small -}}
{{- else if eq (.top.Values.global.performanceProfile | upper) "MEDIUM" -}}
{{- .medium -}}
{{- else -}}
{{- .large -}}
{{- end -}}
{{- end -}}

{{- define "common-lib.monitoring_registry" -}}
{{- if .Values.global.monitoring_registry -}}
{{- .Values.global.monitoring_registry -}}
{{- else -}}
{{- .Values.global.registry -}}
{{- end -}}
{{- end -}}

{{ define "common-lib.rsyslog_client_sidecar" -}}
{{- if .Values.global.rsyslog_enabled }}
- name: rsyslog
  image: "{{ include "common-lib.monitoring_registry" . }}/rsyslog:{{ .Values.global.monitoring_tag }}"
  imagePullPolicy: {{ .Values.image.pullPolicy | quote }}
  env:
    - name: POD_NAME
      valueFrom:
        fieldRef:
          fieldPath: metadata.name
    - name: NODE_NAME
      valueFrom:
        fieldRef:
          fieldPath: spec.nodeName
    - name: RSYSLOG_CLIENT
      value: "true"
    - name: RSYSLOG_SVC_APP_NAME
{{- if .Values.global.use_objectscale_rsyslog }}
      value: {{ .Values.global.objectscale_release_name }}-rsyslog
{{- else }}
      value: {{ .Release.Name }}-rsyslog
{{- end }}
    - name: RSYSLOG_SVC_NAMESPACE
{{- if .Values.global.use_objectscale_rsyslog }}
      value: {{ .Values.global.objectscale_namespace }}
{{- else }}
      value: {{ .Release.Namespace }}
{{- end }}
  volumeMounts:
    - mountPath: /etc/rsyslog.conf.template
      name: rsyslog-config
      subPath: rsyslog.conf
    - name: varlog
      mountPath: /var/log
{{- end }}
{{- end }}

{{ define "common-lib.rsyslog_client_volumes" -}}
{{- if .Values.global.rsyslog_enabled }}
- name: rsyslog-config
  configMap:
    name: {{ .Release.Name }}-rsyslog-client-config
{{- end }}
{{- end }}