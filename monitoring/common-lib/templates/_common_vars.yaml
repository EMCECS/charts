#
# Copyright Â© [2020] Dell Inc. or its subsidiaries.
# All Rights Reserved.
#
# This software contains the intellectual property of Dell Inc.
# or is licensed to Dell Inc. from third parties. Use of this
# software and the intellectual property contained therein is expressly
# limited to the terms and conditions of the License Agreement under which
# it is provided by or on behalf of Dell Inc. or its subsidiaries.
#
#

#
# Entrypoint extention
#
{{- define "common-lib.command" -}}
echo /crash-dump/core-%e > /proc/sys/kernel/core_pattern; ulimit -c unlimited; GOTRACEBACK=crash
{{- end -}}

#
# Influxdb replicas
#
{{- define "common-lib.influxdb_replicas" -}}
{{- if not .Values.global.started -}}
0
{{- else if .Values.global.influxdb_replicas -}}
{{- .Values.global.influxdb_replicas -}}
{{- else if eq (".Values.global.performanceProfile" | upper) "MICRO" -}}
1
{{- else -}}
3
{{- end -}}
{{- end -}}

#
# Influxdb hosts list
#
{{- define "common-lib.influxdb_hosts" -}}
{{- $top := . -}}
{{- $replicas := include "common-lib.influxdb_replicas" . -}}
{{- range $i, $e := until (int $replicas) -}}
{{- if $i}},{{end -}}
{{- if $top.Values.global.tls_enabled -}}
127.0.0.1{{$i}}:8{{$i}}86
{{- else -}}
{{- $top.Release.Name }}-influxdb-{{$i}}.{{ $top.Release.Name }}-influxdb.{{ $top.Release.Namespace }}.svc.cluster.local:8086
{{- end -}}
{{- end -}}
{{- end -}}

#
# Memory limit
#
{{- define "common-lib.memory" -}}
{{- if .top.Values.resources.requests.memory -}}
{{- .top.Values.resources.requests.memory -}}
{{- else -}}
{{- if eq (.top.Values.global.performanceProfile | upper) "MICRO" -}}
{{- .micro -}}
{{- else if eq (.top.Values.global.performanceProfile | upper) "SMALL" -}}
{{- .small -}}
{{- else if eq (.top.Values.global.performanceProfile | upper) "MEDIUM" -}}
{{- .medium -}}
{{- else -}}
{{- .large -}}
{{- end -}}
{{- end -}}
{{- end -}}

#
# Resources section
#
{{- define "common-lib.resources" -}}
  {{- $size := include "common-lib.memory" (dict "top" .top "micro" .micro "small" .small "medium" .medium "large" .large) }}
  {{- $size_units := trim (regexFind "[a-zA-Z]+" $size) -}}
  {{- $size_value := mul 2 (regexFind "[0-9]+" $size) }}
  {{- $storage_ext := 250 }}
  {{- $is_ki := ternary (add $size_value (mul $storage_ext 1024)) 0 (eq $size_units "Ki") }}
  {{- $is_mi := ternary (add $size_value $storage_ext) 0 (or (eq $is_ki 0) (eq $size_units "Mi") ) }}
  {{- $is_gi := ternary (add $storage_ext (mul $size_value 1024)) 0 (eq $size_units "Gi") }}
  {{- $kimi := ternary $is_ki $is_mi (ge $is_ki $is_mi) }}
  {{- $final_size_units := ternary "Mi" $size_units (eq $size_units "Gi") }}
  {{- $storage_size := print (ternary $kimi $is_gi (ge $kimi $is_gi)) $final_size_units -}}
requests:
  memory: {{ $size }}
  ephemeral-storage: {{ $storage_size }}
limits:
  memory: {{ $size }}
  ephemeral-storage: {{ $storage_size }}
{{- end -}}


#
# Application replica count
#
{{- define "common-lib.replicaCount" -}}
{{- if not .top.Values.global.started -}}
0
{{- else if .top.Values.replicaCount -}}
{{- .top.Values.replicaCount -}}
{{- else if eq (.top.Values.global.performanceProfile | upper) "MICRO" -}}
{{- .micro -}}
{{- else if eq (.top.Values.global.performanceProfile | upper) "SMALL" -}}
{{- .small -}}
{{- else if eq (.top.Values.global.performanceProfile | upper) "MEDIUM" -}}
{{- .medium -}}
{{- else -}}
{{- .large -}}
{{- end -}}
{{- end -}}

{{- define "common-lib.monitoring_registry" -}}
{{- if .Values.global.monitoring_registry -}}
{{- .Values.global.monitoring_registry -}}
{{- else -}}
{{- .Values.global.registry -}}
{{- end -}}
{{- end -}}

#
# Rsyslog service name
#
{{- define "common-lib.rsyslog_svc_name" -}}
{{- if .Values.global.objectscale_release_name -}}
{{ .Values.global.objectscale_release_name }}-rsyslog
{{- else -}}
{{ .Release.Name }}-rsyslog
{{- end -}}
{{- end -}}

#
# Rsyslog service namespace
#
{{- define "common-lib.rsyslog_svc_namespace" -}}
{{- if .Values.global.objectscale_namespace -}}
{{ .Values.global.objectscale_namespace }}
{{- else -}}
{{ .Release.Namespace }}
{{- end -}}
{{- end -}}

{{ define "common-lib.rsyslog_client_sidecar" -}}
{{- if and (.Values.global.rsyslog_enabled) (not (.Values.global.logging_injection_enabled)) }}
- name: rsyslog
  image: "{{ include "common-lib.monitoring_registry" . }}/rsyslog:{{ .Values.global.monitoring_tag }}"
  imagePullPolicy: {{ .Values.image.pullPolicy | quote }}
  env:
    - name: POD_NAME
      valueFrom:
        fieldRef:
          fieldPath: metadata.name
    - name: NODE_NAME
      valueFrom:
        fieldRef:
          fieldPath: spec.nodeName
    - name: RSYSLOG_CLIENT
      value: "true"
    - name: RSYSLOG_SVC_NAME
      value: {{ include "common-lib.rsyslog_svc_name" . }}
    - name: RSYSLOG_SVC_NAMESPACE
      value: {{ include "common-lib.rsyslog_svc_namespace" . }}
  volumeMounts:
    - mountPath: /etc/rsyslog.conf.template
      name: rsyslog-config
      subPath: rsyslog.conf
    - name: log
      mountPath: /var/log
{{- end }}
{{- end }}

{{ define "common-lib.rsyslog_client_volumes" -}}
{{- if and (.Values.global.rsyslog_enabled) (not (.Values.global.logging_injection_enabled)) }}
- name: rsyslog-config
  configMap:
    name: {{ .Release.Name }}-rsyslog-client-config
{{- end }}
{{- end }}

{{ define "common-lib.rsyslog_env_file" -}}
/etc/pod.env
{{- end }}

{{ define "common-lib.logging-inject-labels" -}}
{{- if .Values.global.logging_injection_enabled }}
objectscale.dellemc.com/logging-inject: "true"
objectscale.dellemc.com/logging-release-name: "{{ .Release.Name }}"
app.kubernetes.io/namespace: "{{ .Release.Namespace }}"
{{- if not .Values.global.rsyslog_enabled }}
objectscale.dellemc.com/logging-inject-rsyslog: "false"
{{- end }}
{{- end }}
{{- end }}

{{ define "common-lib.logging-inject-logrotate-labels" -}}
{{- if .Values.global.logging_injection_enabled }}
objectscale.dellemc.com/logging-inject-logrotate: "true"
{{- end }}
{{- end }}
