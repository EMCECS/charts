#
# Copyright Â© [2020] Dell Inc. or its subsidiaries.
# All Rights Reserved.
#
# This software contains the intellectual property of Dell Inc.
# or is licensed to Dell Inc. from third parties. Use of this
# software and the intellectual property contained therein is expressly
# limited to the terms and conditions of the License Agreement under which
# it is provided by or on behalf of Dell Inc. or its subsidiaries.
#
#

{{ define "common-lib.telegraf_sidecar" -}}
- name: telegraf
  image: "{{ include "common-lib.monitoring_registry" .top }}/telegraf:{{ .top.Values.image.tag | default .top.Values.global.monitoring_tag }}"
  imagePullPolicy: {{ .top.Values.image.pullPolicy | quote }}
  command: ["bash"]
  args: ["-c", "{{ include "common-lib.command" .top }} HOST_PROC=/proc telegraf --config  /etc/telegraf/telegraf.conf --config-directory /etc/telegraf/telegraf.d/"]
  volumeMounts:
  - name: {{ .volumeName }}
    mountPath: /pv
  - name: telegraf-sidecar-config
    mountPath: /etc/telegraf
{{- if .customConfig }}
  - name: additional-configs
    mountPath: /etc/telegraf/telegraf.d
{{- end }}
{{- end }}

{{ define "common-lib.telegraf_sidecar_volume" -}}
- name: telegraf-sidecar-config
  configMap:
    name: {{ include "common-lib.telegraf_sidecar_config_name" .top }}
{{- if ne .customConfig "" }}
- name: additional-configs
  configMap:
    name: {{ .customConfig }}
{{- end }}
{{- end }}

{{ define "common-lib.telegraf_sidecar_config_name" -}}
{{ .Release.Name }}-telegraf-sidecar
{{- end }}

{{ define "common-lib.telegraf_sidecar_spec_options" -}}
shareProcessNamespace: true
{{- end }}