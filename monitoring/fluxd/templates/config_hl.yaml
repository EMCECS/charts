
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "fluxd.fullname" . }}-hl
  labels:
    app: "{{ template "fluxd.fullname" . }}"
    chart: "{{ template "fluxd.chart" . }}"
    release: {{ .Release.Name }}
data:
  {{- $replicas := include "common-lib.influxdb_replicas" . }}
  {{- $replicas_per_partition := .Values.global.influxdb_replicas_per_partition | default 3 }}
  {{- $partitions_count := int (ceil (div $replicas $replicas_per_partition)) }}
  hl.json: |+
    {
      "range-selection-enabled": true,
      "store-sync-enabled": true,
      "store-type": "k8s",
      "root-store-location": "fluxd-hostlookup-influxdb",
      "start-sleep-max": "30s",
      "update-interval": "5m",
      "check-interval": "5m",
      "writer-check-interval": "200s",
      "history-duration": "120h",
      "init-retry-interval": "20s",
      "request-timeout": "30s",
      "startup-ranges-fill-timeout": "3m",
      "startup-ping-timeout": "20s",
      "online-ping-interval": "30s",
      "online-ping-retries": 3,
      "scale-partitions-count": {{ $partitions_count }},
      "scale-replicas-per-partition": {{ $replicas_per_partition }}
    }