#
# Copyright Â© [2020] Dell Inc. or its subsidiaries.
# All Rights Reserved.
#
# This software contains the intellectual property of Dell Inc.
# or is licensed to Dell Inc. from third parties. Use of this
# software and the intellectual property contained therein is expressly
# limited to the terms and conditions of the License Agreement under which
# it is provided by or on behalf of Dell Inc. or its subsidiaries.
#
#

suite: test deployment
templates:
  - deployment.yaml
tests:
  - it: tls enabled
    set:
      global.tls_enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[2].volumeMounts
          content:
            mountPath: /etc/nginx/cert
            name: cert
      - contains:
          path: spec.template.spec.volumes
          content:
            name: cert
            configMap:
              name: RELEASE-NAME-cert
  - it: tls disabled
    set:
      global.tls_enabled: false
    asserts:
      - notContains:
          path: spec.template.spec.volumes
          content:
            name: cert
            configMap:
              name: RELEASE-NAME-cert
  - it: retention settings
    set:
      config.tsdb_retention: 10d
      config.alertmanager_retention: 24h
    asserts:
      - equal:
          path: spec.template.spec.containers[0].args[1]
          value: --storage.tsdb.retention.time=10d
      - equal:
          path: spec.template.spec.containers[1].args[2]
          value: --data.retention=24h

suite: test replicas
templates:
  - deployment.yaml
tests:
  - it: Started
    asserts:
      - equal:
          path: spec.replicas
          value: 1
  - it: Stopped
    set:
      global.started: false
    asserts:
      - equal:
          path: spec.replicas
          value: 0
