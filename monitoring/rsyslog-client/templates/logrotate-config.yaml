#
# Copyright Â© [2020] Dell Inc. or its subsidiaries.
# All Rights Reserved.
#
# This software contains the intellectual property of Dell Inc.
# or is licensed to Dell Inc. from third parties. Use of this
# software and the intellectual property contained therein is expressly
# limited to the terms and conditions of the License Agreement under which
# it is provided by or on behalf of Dell Inc. or its subsidiaries.
#
#

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "rsyslog-client.fullname" . }}-logrotate-config
  labels:
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
data:
  svc: |+
    /var/log/*.log
    {
      missingok
      copytruncate
      nocreate
      nosharedscripts
      size=+10M
      rotate 10
      prerotate
      endscript
      postrotate
      endscript
    }
  logrotate.conf: |+
    # see "man logrotate" for details
    # rotate log files daily
    daily

    # keep rotated logs for 14 week max
    maxage 14

    # logrotate requires that the number of logs to rotate
    # is configured.  Since 1 week should be retained and
    # logrotate runs every 10 minutes count should be 6 * 24 * 7 = 1008 logs
    # to make sure none are deleted early.  Rounded up to 1010 to
    # give some leeway
    rotate 1010

    # create new (empty) log files after rotating old ones
    create

    # use date as a suffix of the rotated file
    dateext

    # Add a dateformat with seconds
    dateformat -%Y%m%d-%s

    # max size is 5 MB
    size 5M

    # Compress log files
    compress

    # comment these to switch compression to use gzip or another
    # compression scheme
    compresscmd /usr/bin/gzip
    uncompresscmd /usr/bin/gunzip

    # rotate logs as root
    su root root

    # RPM packages drop log rotation information into this directory
    include /etc/logrotate.d
