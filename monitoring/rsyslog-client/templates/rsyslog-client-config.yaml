#
# Copyright Â© [2020] Dell Inc. or its subsidiaries.
# All Rights Reserved.
#
# This software contains the intellectual property of Dell Inc.
# or is licensed to Dell Inc. from third parties. Use of this
# software and the intellectual property contained therein is expressly
# limited to the terms and conditions of the License Agreement under which
# it is provided by or on behalf of Dell Inc. or its subsidiaries.
#
#

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-rsyslog-client-config
  labels:
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
data:
  rsyslog.conf: |+
    #### MODULES ####

    # input module: file
    module(load="imfile")

    #### GLOBAL DIRECTIVES ####

    #### RULES ####

    # input log files
    input(type="imfile"
          File="/var/log/*.log"
          Tag="{{ .Release.Name }}"
          addMetadata="on"
          Ruleset="handle_multiple_logs"
    )

    ruleset(name="handle_multiple_logs") {
      # http://www.rsyslog.com/doc/v8-stable/rainerscript/functions.html
      # re_extract(expr, re, match, submatch, no-found)
      set $.suffix=re_extract($!metadata!filename, "(.*)/([^/]*)", 0, 2, "all.log");
      set $.pod_name=getenv("POD_NAME");
      call sendToLogserver
    }

    # output template
    template(name="FileFormat" type="string"
    string= "<%PRI%>%TIMESTAMP% %HOSTNAME% %syslogtag%__%$.pod_name%__%$.suffix%%msg:::sp-if-no-1st-sp%%msg:::drop-last-lf%\n"
            )

    ruleset(name="sendToLogserver") {
      action(type="omfwd"
          Target="_RSYSLOG_POD_NAME_.{{ include "common-lib.rsyslog_svc_name" . }}.{{ include "common-lib.rsyslog_svc_namespace" . }}.svc.cluster.local"
          Port="{{ .Values.config.output.port }}"
          Protocol="tcp"
          Template="FileFormat" )
    #    action.resumeRetryCount={{ .Values.config.output.resumeRetryCount }}
    #    queue.type={{ .Values.config.output.queue.type }} queue.size={{ .Values.config.output.queue.size }})
    }
