#
# Copyright Â© [2020] Dell Inc. or its subsidiaries.
# All Rights Reserved.
#
# This software contains the intellectual property of Dell Inc.
# or is licensed to Dell Inc. from third parties. Use of this
# software and the intellectual property contained therein is expressly
# limited to the terms and conditions of the License Agreement under which
# it is provided by or on behalf of Dell Inc. or its subsidiaries.
#
#

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "rsyslog.fullname" . }}
  labels:
    app.kubernetes.io/name: {{ template "rsyslog.fullname" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
data:
  rsyslog.conf: |+
    #### MODULES ####

    # input module: unix socket
    module(load="imtcp")

    #### RULES ####

    template(name="jsonLogForwardFormat" type="string"
         string="{\"cluster\":\"{{ .Values.global.cluster_name }}\",\"host\":\"%$.my_hostname%\",\"message\":\"%rawmsg:::json%\"}\n")

    # input unix socket
    input(type="imtcp" port="{{ .Values.service.bind_address }}" ruleset="RemoteLogProcess")

    # output template
    template(name="OnlyMsg" type="string" string="%msg:::drop-last-lf%\n")

    # output file path
    template(name="RemoteLogSavePath" type="list") {
        constant(value="{{ .Values.config.storage_directory }}")
        constant(value="/")
        property(name="$.logpath" )
    }

    # output ruleset
    ruleset(name="RemoteLogProcess") {
        # For facilities local0-7 set log filename from $programname field: replace __ with /
        # Message has arbitary format, syslog fields are not used
        if ( $syslogfacility >= 16 ) then
        {
            set $.logpath = replace($programname, "__", "/");
            action(type="omfile" dynaFileCacheSize="1024" dynaFile="RemoteLogSavePath" template="OnlyMsg"
            flushOnTXEnd="off" asyncWriting="on" flushInterval="1" ioBufferSize="64k")

        # Logs with filename defined from facility
        # Message has syslog format, syslog fields are used
        } else {
            if (($syslogfacility == 0)) then {
        	    set $.logpath = "kern";
            } else if (($syslogfacility == 4) or ($syslogfacility == 10)) then {
                set $.logpath = "auth";
            } else if (($syslogfacility == 9) or ($syslogfacility == 15)) then {
                set $.logpath = "cron";
            } else {
                set $.logpath ="syslog";
            }
            # Built-in template RSYSLOG_FileFormat: High-precision timestamps and timezone information
            action(type="omfile" dynaFileCacheSize="1024" dynaFile="RemoteLogSavePath" template="RSYSLOG_FileFormat"
            flushOnTXEnd="off" asyncWriting="on" flushInterval="1" ioBufferSize="64k")
        }

        {{- if .Values.logReceiver.enable }}
        set $.my_hostname=getenv("HOSTNAME");
        # Send to logstash
        action(
            type="omfwd"
            Target="{{ .Values.logReceiver.host }}"
            Port="{{ .Values.logReceiver.port }}"
            Protocol="tcp"
            template="jsonLogForwardFormat"
        )
        {{- end }}
    }
