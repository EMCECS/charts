#
# Copyright Â© [2020] Dell Inc. or its subsidiaries.
# All Rights Reserved.
#
# This software contains the intellectual property of Dell Inc.
# or is licensed to Dell Inc. from third parties. Use of this
# software and the intellectual property contained therein is expressly
# limited to the terms and conditions of the License Agreement under which
# it is provided by or on behalf of Dell Inc. or its subsidiaries.
#
#

suite: test deployment
templates:
  - configmap.yaml
tests:
  - it: multiple partitions
    set:
      global.influxdb_replicas: 6
      global.influxdb_replicas_per_partition: 3
      config:
        outputs:
         - influxdb:
             insecure_skip_verify: true
    asserts:
      - matchRegex:
          path: data.telegraf\.conf
          pattern: influxdb\-0\.RELEASE\-NAME\-influxdb\.NAMESPACE\.svc\.cluster\.local\:8086\"\]\n\s+insecure_skip_verify = true\n\s+\[outputs.influxdb.hashpass\]\n\s+partitionpass = 0\n\s+partitions = 2\n
      - matchRegex:
          path: data.telegraf\.conf
          pattern: influxdb\-1\.RELEASE\-NAME\-influxdb\.NAMESPACE\.svc\.cluster\.local\:8086\"\]\n\s+insecure_skip_verify = true\n\s+\[outputs.influxdb.hashpass\]\n\s+partitionpass = 0\n\s+partitions = 2\n
      - matchRegex:
          path: data.telegraf\.conf
          pattern: influxdb\-2\.RELEASE\-NAME\-influxdb\.NAMESPACE\.svc\.cluster\.local\:8086\"\]\n\s+insecure_skip_verify = true\n\s+\[outputs.influxdb.hashpass\]\n\s+partitionpass = 0\n\s+partitions = 2\n
      - matchRegex:
          path: data.telegraf\.conf
          pattern: influxdb\-3\.RELEASE\-NAME\-influxdb\.NAMESPACE\.svc\.cluster\.local\:8086\"\]\n\s+insecure_skip_verify = true\n\s+\[outputs.influxdb.hashpass\]\n\s+partitionpass = 1\n\s+partitions = 2\n
      - matchRegex:
          path: data.telegraf\.conf
          pattern: influxdb\-4\.RELEASE\-NAME\-influxdb\.NAMESPACE\.svc\.cluster\.local\:8086\"\]\n\s+insecure_skip_verify = true\n\s+\[outputs.influxdb.hashpass\]\n\s+partitionpass = 1\n\s+partitions = 2\n
      - matchRegex:
          path: data.telegraf\.conf
          pattern: influxdb\-5\.RELEASE\-NAME\-influxdb\.NAMESPACE\.svc\.cluster\.local\:8086\"\]\n\s+insecure_skip_verify = true\n\s+\[outputs.influxdb.hashpass\]\n\s+partitionpass = 1\n\s+partitions = 2\n
      - notMatchRegex:
          path: data.telegraf\.conf
          pattern: influxdb\-6
      - notMatchRegex:
          path: data.telegraf\.conf
          pattern: partitions = 3
      - notMatchRegex:
          path: data.telegraf\.conf
          pattern: partitionpass = 2
  - it: single partition
    set:
      config:
        outputs:
         - influxdb:
             insecure_skip_verify: true
    asserts:
      - notMatchRegex:
          path: data.telegraf\.conf
          pattern: hashpass
      - matchRegex:
          path: data.telegraf\.conf
          pattern: influxdb\-0
      - matchRegex:
          path: data.telegraf\.conf
          pattern: influxdb\-1
      - matchRegex:
          path: data.telegraf\.conf
          pattern: influxdb\-2
      - notMatchRegex:
          path: data.telegraf\.conf
          pattern: influxdb\-3
