import "http"

// Aggregated used capacity by region: to calculate user data, system metadata, protection overhead, garbage
// Depends on gc-stats, capacity-used-elements CQ: MONITORING-795

from(bucket: "monitoring_vdc")
|> filter(fn: (r) => r._measurement == "cq_gc_data" or
                     r._measurement == "cq_capacity_used_elements")
|> range(start:{{ .Start }},stop:{{ .Stop }})
|> last()
|> keep(columns: ["_field", "_stop", "_value",])
|> group(columns: ["_field", "_stop"])
|> sum()
|> rename(columns:{_stop: "_time"})
|> pivot(rowKey:["_time"], columnKey: ["_field"], valueColumn: "_value")
