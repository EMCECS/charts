#
# Copyright Â© [2020] Dell Inc. or its subsidiaries.
# All Rights Reserved.
#
# This software contains the intellectual property of Dell Inc.
# or is licensed to Dell Inc. from third parties. Use of this
# software and the intellectual property contained therein is expressly
# limited to the terms and conditions of the License Agreement under which
# it is provided by or on behalf of Dell Inc. or its subsidiaries.
#
#
{{- if .Values.config.alerter.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: "{{ template "throttler.fullname" . }}-alerter"
  labels:
    app: "{{ template "throttler.fullname" . }}"
    chart: "{{ template "throttler.chart" . }}"
    release: {{ .Release.Name }}
data:
  {{- $top := . }}
  alerts.yaml: |-
    alerts:
      {{- range .Values.config.alerter.alerts }}
      - id: {{ .id }}
        enabled: {{ .enabled }}
        application: {{ template "throttler.fullname" $top }}
        component: {{ $top.Values.config.alerter.component }}
        range: {{ .range }}
        query_path: alert_{{ .id }}.flux
        symptoms:
        {{- range .symptoms }}
          - id: {{ .id }}
            types:
            {{- range .types }}
              - {{ . }}
            {{- end }}
        {{- end }}
      {{- end }}

  {{- /* Flux query files */ -}}
  {{- range .Values.config.alerter.alerts }}
  {{- $fname := printf "alert_%s.flux" .id }}
  {{- $path := printf "%s/%s" $top.Values.config.alerter.dir $fname }}
  {{ $fname }}: |-
    {{- $top.Files.Get $path | nindent 4 }}
  {{- end }}

  event.tmpl: |-
    {{- .Files.Get "alerts/common/event.tmpl" | nindent 4 }}
{{- end }}
