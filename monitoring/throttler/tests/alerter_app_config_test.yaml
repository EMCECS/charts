#
# Copyright Â© [2020] Dell Inc. or its subsidiaries.
# All Rights Reserved.
#
# This software contains the intellectual property of Dell Inc.
# or is licensed to Dell Inc. from third parties. Use of this
# software and the intellectual property contained therein is expressly
# limited to the terms and conditions of the License Agreement under which
# it is provided by or on behalf of Dell Inc. or its subsidiaries.
#
#

suite: test alerter event rules configmap
templates:
  - alerter_app_config.yaml
tests:
  - it: alerter enabled
    set:
      config:
        alerter:
          dir: "test_alert"
          enabled: true
          alerts:
            - id: "test"
              enabled: true
              symptoms:
                - id: 111
                  type: Warning
                  event_rule:
                    description: "rule 111"
                    notifiers:
                      - n1
                      - n2
                      - n3
                  event_remedy:
                    description: "remedy 111"
                    remedies:
                      - remedy 111
                - id: 112
                  type: Critical
                  event_rule:
                    description: "rule 112"
                    notifiers:
                      - n1
                  event_remedy:
                    description: "remedy 112"
                    remedies:
                      - remedy 112
            - id: "test_2"
              enabled: false
              symptoms:
                - id: 222
                  type: Critical
                  event_rule:
                    description: "rule 222"
                    notifiers:
                      - n2
                  event_remedy:
                    description: "remedy 222"
                    remedies:
                      - remedy 222
    asserts:
      - equal:
          path: metadata.annotations.com\.dellemc\.kahm\.subscribed
          value: "true"
      - equal:
          path: data.eventRules
          value: |-
            rules:
              - description: rule 111
                matchon:
                - label: SymptomID
                  value: 111
                notifiers:
                 - n1
                 - n2
                 - n3
              - description: rule 112
                matchon:
                - label: SymptomID
                  value: 112
                notifiers:
                 - n1
              - description: rule 222
                matchon:
                - label: SymptomID
                  value: 222
                notifiers:
                 - n2
      - equal:
          path: data.eventRemedies
          value: |-
            symptoms:
              - symptomid: 111
                description: remedy 111
                remedies:
                 - remedy 111
              - symptomid: 112
                description: remedy 112
                remedies:
                 - remedy 112
              - symptomid: 222
                description: remedy 222
                remedies:
                 - remedy 222
  - it: alerter disabled
    set:
      config.alerter.enabled: false
    asserts:
      - hasDocuments:
          count: 0
