apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: sonobuoy-cronjob
  namespace: default
spec:
  schedule: "0 2 * * 1" # The job is running every Monday at 2am by default
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 0
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - image: {{ .Values.global.registry }}/{{ .Values.alpine_curl_image.repository }}:{{ .Values.tag }}
            env:
            - name: curSecret
              value: {{ .Values.global.registrySecret }}
            command:
              - /bin/sh
              - -c
              - curl -k -X DELETE -H "Authorization:Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" https://$KUBERNETES_SERVICE_HOST:$KUBERNETES_PORT_443_TCP_PORT/api/v1/namespaces/heptio-sonobuoy/pods;
                sleep 60;
                curl -k -X GET -H "Authorization:Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" https://$KUBERNETES_SERVICE_HOST:$KUBERNETES_PORT_443_TCP_PORT/api/v1/namespaces/default/secrets/$curSecret > imagePullSecret.json;
                sed -i 's/default/heptio-sonobuoy/g' imagePullSecret.json;
                sed -i '/resourceVersion/'d imagePullSecret.json;
                curl -k -X POST -H "Authorization:Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" -H "Content-Type:application/json" https://$KUBERNETES_SERVICE_HOST:$KUBERNETES_PORT_443_TCP_PORT/api/v1/namespaces/heptio-sonobuoy/secrets -d@imagePullSecret.json;
                echo start creating sonobuoy job;
                curl -k -X POST -H "Authorization:Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" -H "Content-Type:application/json" https://$KUBERNETES_SERVICE_HOST:$KUBERNETES_PORT_443_TCP_PORT/api/v1/namespaces/heptio-sonobuoy/pods -d@/etc/sonobuoy/sonobuoy-cronjob.json;
            imagePullPolicy: {{ .Values.pullPolicy }}
            name: alpine-curl
            volumeMounts:
            - mountPath: /etc/sonobuoy
              name: sonobuoy-volume-config
          restartPolicy: Never
          volumes:
          - configMap:
              name: sonobuoy-config-cronjob
            name: sonobuoy-volume-config
